// @Fleetbo Deploy
// @Fleetbo ModuleName: PermissionModule
// @Fleetbo manifest:Root <uses-permission android:name="android.permission.CAMERA" />
// @Fleetbo manifest:Root <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
// @Fleetbo manifest:Root <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />

package com.fleetbo.user.modules

import android.Manifest
import android.app.Activity
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.provider.Settings
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.fleetbo.sdk.FleetboModule

class PermissionModule(private val context: Context, communicator: Any) : FleetboModule(context, communicator) {

    // Check permission status - returns detailed status
    fun check(callbackId: String, params: String) {
        val permissionType = parseParams(params)?.get("type")?.asString ?: "camera"
        
        val permission = getManifestPermission(permissionType)
        if (permission.isEmpty()) {
            sendError(callbackId, "Unknown permission type: $permissionType")
            return
        }

        val activity = getCurrentActivity()
        if (activity == null) {
            sendError(callbackId, "No activity available")
            return
        }

        val granted = ContextCompat.checkSelfPermission(activity, permission) == PackageManager.PERMISSION_GRANTED
        val shouldShowRationale = ActivityCompat.shouldShowRequestPermissionRationale(activity, permission)

        val response = when {
            granted -> mapOf(
                "granted" to true,
                "permission" to permissionType,
                "status" to "granted"
            )
            shouldShowRationale -> mapOf(
                "granted" to false,
                "permission" to permissionType,
                "status" to "denied",
                "canRequest" to true
            )
            else -> mapOf(
                "granted" to false,
                "permission" to permissionType,
                "status" to "blocked",
                "canRequest" to false
            )
        }

        sendSuccess(callbackId, response)
    }

    // Request permission - triggers system dialog
    fun request(callbackId: String, params: String) {
        val permissionType = parseParams(params)?.get("type")?.asString ?: "camera"
        
        val permission = getManifestPermission(permissionType)
        if (permission.isEmpty()) {
            sendError(callbackId, "Unknown permission type: $permissionType")
            return
        }

        val activity = getCurrentActivity()
        if (activity == null) {
            sendError(callbackId, "No activity available")
            return
        }

        val alreadyGranted = ContextCompat.checkSelfPermission(activity, permission) == PackageManager.PERMISSION_GRANTED

        if (alreadyGranted) {
            // Already granted
            val response = mapOf(
                "granted" to true,
                "permission" to permissionType,
                "status" to "granted"
            )
            sendSuccess(callbackId, response)
            
            // Emit event
            emitEvent("PERMISSION_GRANTED", mapOf("permission" to permissionType))
        } else {
            // Request permission - this triggers system dialog
            val requestCode = when (permissionType) {
                "camera" -> REQUEST_CODE_CAMERA
                "gallery", "photos" -> REQUEST_CODE_GALLERY
                else -> REQUEST_CODE_CAMERA
            }

            ActivityCompat.requestPermissions(activity, arrayOf(permission), requestCode)

            // Emit event that permission is being requested
            emitEvent("PERMISSION_REQUESTED", mapOf("permission" to permissionType))

            // Return pending status
            val response = mapOf(
                "granted" to false,
                "permission" to permissionType,
                "status" to "pending"
            )
            sendSuccess(callbackId, response)
        }
    }

    // Open app settings
    fun openSettings(callbackId: String, params: String) {
        try {
            val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
                data = Uri.fromParts("package", context.packageName, null)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            context.startActivity(intent)
            sendSuccess(callbackId, mapOf("success" to true))
        } catch (e: Exception) {
            sendError(callbackId, "Failed to open settings: ${e.message}")
        }
    }

    // Handle permission result from system
    fun onRequestPermissionsResult(requestCode: Int, permissions: Array<String>, grantResults: IntArray) {
        val (permissionType, eventName) = when (requestCode) {
            REQUEST_CODE_CAMERA -> "camera" to "CAMERA_PERMISSION_RESULT"
            REQUEST_CODE_GALLERY -> "gallery" to "GALLERY_PERMISSION_RESULT"
            else -> return
        }

        val granted = grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED

        // Emit result event
        val response = mapOf(
            "permission" to permissionType,
            "granted" to granted,
            "status" if granted else "status" to if (granted) "granted" else "denied"
        )
        
        emitEvent(eventName, response)
        
        // Also emit generic event
        emitEvent("PERMISSION_RESULT", response)
    }

    private fun getManifestPermission(permissionType: String): String {
        return when (permissionType.lowercase()) {
            "camera" -> Manifest.permission.CAMERA
            "gallery", "photos", "media" -> if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                Manifest.permission.READ_MEDIA_IMAGES
            } else {
                Manifest.permission.READ_EXTERNAL_STORAGE
            }
            else -> ""
        }
    }

    companion object {
        const val REQUEST_CODE_CAMERA = 1001
        const val REQUEST_CODE_GALLERY = 1002
    }
}
